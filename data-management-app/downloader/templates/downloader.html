
{% extends "layout.html" %}
{% block content %}


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.2.3/flatpickr.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.2.3/themes/dark.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.2.3/flatpickr.js"></script>



<style>

    .message-box, .download-form {
        position: absolute;
        left: 3%;
        width: 35%;
        }

    .message-box {
        top: 120px;
        height: 6%;
        }

    .download-form {
        top: calc(8% + 120px);
        padding-left: 2%;
        height: 72%;
        }

    .select2-selection__arrow b{
        display:none !important;
    }

    .download-form h6 {
        margin-bottom: 5%;
        margin-top: 7%;
        }

    .date-range, .entity-select, .file-select {
        width: 60%;
        font-size: 14px;
        padding-left: 2.5%;
        background-color: rgba(15, 17, 22, 0.8);
        color: #d6d6d6;
        }

    .date-range, .select2-container, .select2-selection--single, .select2-container--default {
        height: 40px !important;
        border: 1px solid rgba(250,250,250,0.2);
        border-radius: 3px;
        }
    .date-range, .select2-container {box-shadow: inset 0 0 1em rgba(0, 170, 170, 0.2), 0 0 1em rgba(0, 170, 170, 0.2);}
    .date-range:hover, .select2-container:hover {box-shadow: inset 0 0 1em rgba(0, 170, 170, 0.5), 0 0 1em rgba(0, 170, 170, 0.5);}


    .select2-container--default .select2-selection--single {background-color: transparent; border: none;}
    .select2-results {background-color: rgba(15, 17, 22, 0.8); color: #d6d6d6;}
    .select2-container--default .select2-selection--single .select2-selection__rendered {color: #d6d6d6 !important; line-height: 38px;}

    .fuller-button {
        width: 50%;
        margin-top: 10%;
        }

</style>




<div class="background-content">

    <img src="{{ url_for('static', filename='images/background/' + 'base_v4.jpg') }}" width="100%">

    <div class="message-box unselectable">
        <div style="display: table; width: 100%;">
            <div class="page-title title-img">
                <?xml version="1.0" ?>
                <svg id="Layer_1" viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg">
                    <path class="cls-1" d="M7.85,12.15l-.71.71,5,5a.5.5,0,0,0,.71,0l5-5-.71-.71L13,16.29V0H12V16.29Z"/><path class="cls-1" d="M15.78,2.52l-.29,1a10.48,10.48,0,1,1-6,0l-.29-1A11.48,11.48,0,1,0,24,13.52,11.55,11.55,0,0,0,15.78,2.52Z"/>
                </svg>
            </div>
            <div class="page-title title-text">DOWNLOADER</div>
        </div>
        <div class="title-hr"></div>
    </div>

    <form class="download-form" method="POST">

        <h6>1. Filetype</h6>
        <select class="file-select" name="filetype" required>
            <option selected disabled></option>
        </select>

        <h6>2. Date range</h6>
        <input type="text" class="date-range" placeholder="" data-input name="date-range" required>

        <h6>3. Entity</h6>
        <select class="entity-select" name="entity" required>
            <option selected disabled></option>
        </select>

        <div class="fuller-button">DOWNLOAD</div>

    </form>

</div>


<script>

    function parseDate(str) {
        var ymd = str.split('-');
        return new Date(ymd[0], ymd[1]-1, ymd[2]);
    }

    function datediff(first, second) {
        return Math.round((second-first)/(1000*60*60*24));
    }

    function dateRangeCheck () {

        var start = parseDate($('.date-range').val().split(' to ')[0]);
        var end = parseDate($('.date-range').val().split(' to ')[1]);

        if ( datediff(start, end) >= {{ days_cutoff }}) {

            var myDate = new Date(+start + {{ days_cutoff }} *86400000);
            return myDate.getFullYear() + "-" + (myDate.getMonth()+1) + "-" + myDate.getDate();

        };

        return;
    };

</script>
<script>

    $('.fuller-button').on('click', function () {

        var rangeCheck = dateRangeCheck()

        if ( !rangeCheck ) {

            var downloadForm = $(this).parent('form');

            if( downloadForm[0].checkValidity() ) {

                if ( $('.date-range').val() !== '' ) {

                    downloadForm.submit();
                    $('.fuller-button').prop('onclick', null).off('click');
                    $('.fuller-button').addClass('reset-warning');

                    $('.reset-warning').on('click', function () {

                        Swal.fire({
                            html: "Please refresh the page to commence another download.",
                            type: "error"
                        });

                    });

                } else {

                    return;

                };

            } else {

                downloadForm[0].reportValidity();
                $('.date-checker').attr('required',false);

            };

        } else {

            Swal.fire({
                html: "According to your specified start date, the last allowed date within the 180 day cutoff would be <b>" + rangeCheck + "</b>",
                type: "error"
            });
            $('.swal2-modal').css('border', '1px solid rgba(250,0,0,0.2)');

        }

    });



</script>
<script>

    $(document).ready( function () {

        $('.message-box .title-text').fitText(1.5);
        $('.download-form h6').fitText(2.4);
        $('.date-range').fitText(1.4);

    });

</script>
<script>

    $(".date-range").flatpickr({
        mode: 'range',
        dateFormat: "Y-m-d"
    });

</script>
<script>

    $(document).ready(function() {
        $('.entity-select').select2({
            tags: false,
            width: '60%',
            minimumResultsForSearch: -1,
            data: [
                   { id: "device_status", text: "Device Status"},
                   { id: "entries", text: "Entries"},
                   { id: "treatments", text: "Treatments"}
                  ]
        });
        $('.entity-select').fitText(1.4);
    });
    $(document).ready(function() {
        $('.file-select').select2({
            tags: false,
            width: '60%',
            minimumResultsForSearch: -1,
            data: [
                   { id: "json", text: ".json"},
                   { id: "csv", text: ".csv"}
                  ]
        });
        $('.entity-select').fitText(1.4);
    });

</script>
{% endblock content %}